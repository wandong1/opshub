version: '3.8'

services:
  mysql:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/mysql:8.0.44
    container_name: opshub-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-OpsHub@2026}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-opshub}
      TZ: Asia/Shanghai
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  db-init:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/mysql:8.0.44
    container_name: opshub-db-init
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./migrations/init.sql:/init.sql:ro,z
    entrypoint: >
      sh -c "mysql -h mysql -u root -p'OpsHub@2026' opshub < /init.sql && echo 'Database initialized successfully'"
    networks:
      - opshub-network

  redis:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/redis:7-alpine
    container_name: opshub-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  clickhouse:
    image: clickhouse/clickhouse-server:24-alpine
    container_name: opshub-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-opshub}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-OpsHub@2026}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-default}
      TZ: Asia/Shanghai
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_TCP_PORT:-9000}:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "clickhouse-client", "--user", "opshub", "--password", "OpsHub@2026", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  mongodb:
    image: mongo:7
    container_name: opshub-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-opshub}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-OpsHub@2026}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-opshub}
      TZ: Asia/Shanghai
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "-u", "opshub", "-p", "OpsHub@2026", "--authenticationDatabase", "admin"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  kafka:
    image: apache/kafka:3.9.0
    container_name: opshub-kafka
    restart: unless-stopped
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: opshub-kafka-cluster-00001
      TZ: Asia/Shanghai
    ports:
      - "${KAFKA_PORT:-9094}:9094"
    volumes:
      - kafka-data:/tmp/kraft-combined-logs
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 > /dev/null 2>&1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - opshub-network

  milvus-etcd:
    image: quay.io/coreos/etcd:v3.5.16
    container_name: opshub-milvus-etcd
    restart: unless-stopped
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    volumes:
      - milvus-etcd-data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  milvus-minio:
    image: minio/minio:RELEASE.2024-09-22T00-33-43Z
    container_name: opshub-milvus-minio
    restart: unless-stopped
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - milvus-minio-data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opshub-network

  milvus:
    image: milvusdb/milvus:v2.4.17
    container_name: opshub-milvus
    restart: unless-stopped
    environment:
      ETCD_ENDPOINTS: milvus-etcd:2379
      MINIO_ADDRESS: milvus-minio:9000
      COMMON_SECURITY_AUTHORIZATIONENABLED: "true"
      TZ: Asia/Shanghai
    ports:
      - "${MILVUS_PORT:-19530}:19530"
      - "${MILVUS_GRPC_PORT:-9091}:9091"
    volumes:
      - milvus-data:/var/lib/milvus
    command: ["milvus", "run", "standalone"]
    depends_on:
      milvus-etcd:
        condition: service_healthy
      milvus-minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      - opshub-network

        #  backend:
        #    image: dyclouds/opshub-api:latest
        #    container_name: opshub-backend
        #    restart: unless-stopped
        #    ports:
        #      - "${BACKEND_PORT:-9876}:9876"
        #    environment:
        #      OPSHUB_SERVER_MODE: ${OPSHUB_SERVER_MODE:-release}
        #      OPSHUB_SERVER_HTTP_PORT: 9876
        #      OPSHUB_SERVER_JWT_SECRET: ${OPSHUB_SERVER_JWT_SECRET:-opshub-jwt-secret-change-in-production}
        #      OPSHUB_SERVER_JWT_EXPIRE: 24h
        #      OPSHUB_DATABASE_HOST: mysql
        #      OPSHUB_DATABASE_PORT: 3306
        #      OPSHUB_DATABASE_DATABASE: ${MYSQL_DATABASE:-opshub}
        #      OPSHUB_DATABASE_USERNAME: ${MYSQL_USERNAME:-root}
        #      OPSHUB_DATABASE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-OpsHub@2026}
        #      OPSHUB_REDIS_HOST: redis
        #      OPSHUB_REDIS_PORT: 6379
        #      OPSHUB_REDIS_PASSWORD: ""
        #      OPSHUB_REDIS_DB: 0
        #      TZ: Asia/Shanghai
        #    depends_on:
        #      mysql:
        #        condition: service_healthy
        #      redis:
        #        condition: service_healthy
        #    volumes:
        #      - ./logs:/app/logs
        #    networks:
        #      - opshub-network

        #  frontend:
        #    image: dyclouds/opshub-web:latest
        #    container_name: opshub-frontend
        #    restart: unless-stopped
        #    ports:
        #      - "${FRONTEND_PORT:-80}:80"
        #    environment:
        #      - TZ=Asia/Shanghai
        #    depends_on:
        #      - backend
        #    volumes:
        #      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
        #    networks:
        #      - opshub-network

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  clickhouse-data:
    driver: local
  mongodb-data:
    driver: local
  kafka-data:
    driver: local
  milvus-etcd-data:
    driver: local
  milvus-minio-data:
    driver: local
  milvus-data:
    driver: local

networks:
  opshub-network:
    driver: bridge
